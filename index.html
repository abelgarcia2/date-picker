<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>

    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
        }

        table {
            cursor: default;
            border-collapse: collapse;
        }

        .header {
            display: flex;
            justify-content: space-between;
            padding: 7px 0;
            background-color: #828282;
        }

        .day-names {
            background-color: #e7e7e7;
        }

        .calendar {
            width: 100%;
        }

        .marked {
            background-color: #cecece;
        }

        .weekend {
            color: red;
        }

        .disabled {
            opacity: .3;
        }

        td {
            text-align: center;
        }

        button {
            background-color: transparent;
            border: none;
            /* font-size: xx-large; */
            font-weight: bolder;
            cursor: pointer;
        }

        select {
            font-family: inherit;
            background-color: transparent;
            border: none;
        }

        input {
            font-family: inherit;
            border: none;
            width: fit-content;
            outline: none;
            background-color: inherit;
        }

        input:focus,
        select:focus {
            background-color: #c8c8c8;
        }
    </style>
</head>

<body>
    <div class="header">
        <button id="previousMonth">&larr;</button>
        <select id="monthSelector"></select>
        <input id="yearSelector" type="number" min="0" max="9999" />
        <button id="nextMonth">&rarr;</button>
    </div>

    <table class="calendar">
        <thead>
            <tr class="day-names">
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th class="weekend"></th>
                <th class="weekend"></th>
            </tr>
        </thead>

        <tbody>
            <tr>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day weekend"></td>
                <td class="day weekend"></td>
            </tr>
            <tr>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day weekend"></td>
                <td class="day weekend"></td>
            </tr>
            <tr>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day weekend"></td>
                <td class="day weekend"></td>
            </tr>
            <tr>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day weekend"></td>
                <td class="day weekend"></td>
            </tr>
            <tr>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day weekend"></td>
                <td class="day weekend"></td>
            </tr>
            <tr>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day"></td>
                <td class="day weekend"></td>
                <td class="day weekend"></td>
            </tr>

        </tbody>
    </table>

    <script>
        const $ = document.querySelector.bind(document);

        const N_DAYS = 7;
        const N_WEEKS = 6;

        const DATETIME_FORMAT = new Intl.DateTimeFormat(undefined, { month: "long", weekday: "short" });

        let currentDate = new Date();
        currentDate.setHours(0);
        currentDate.setMinutes(0);
        currentDate.setSeconds(0);
        currentDate.setMilliseconds(0);
        let markedDate = new Date();
        markedDate.setTime(currentDate.getTime());

        let dates = (() => {
            let dates = new Array(N_WEEKS);
            for (let i = 0; i < dates.length; i++) {
                dates[i] = new Array(N_DAYS);
            }
            return dates;
        })();

        populateDayNames();
        populateMonthSelector();
        onDateChanged();

        // ========================== SELECTORS ==========================================

        $('#monthSelector').addEventListener('change', (event) => {
            let month = event.target.value;
            currentDate.setMonth(month);
            onDateChanged();
        });

        $('#yearSelector').addEventListener('keydown', function (event) {
            let isNumber = /^[0-9]$/.test(event.key);

            if (event.target.value.length >= 4 && event.key != "Backspace") {
                event.preventDefault();
            }
            if (!isNumber && event.key != "Backspace") {
                event.preventDefault();
            }
        });


        $('#yearSelector').addEventListener('change', function (event) {
            let year = event.target.value;
            currentDate.setFullYear(year);
            onDateChanged();
        })
        // ========================== SELECTORS ==========================================


        // ========================== LISTENERS ==========================================
        $('#previousMonth').addEventListener('click', () => {
            if (currentDate.getMonth() == 0) {
                currentDate.setMonth(11);
                currentDate.setFullYear(currentDate.getFullYear() - 1);
            } else {
                currentDate.setMonth(currentDate.getMonth() - 1);
            }
            onDateChanged();
        });

        $('#nextMonth').addEventListener('click', () => {
            if (currentDate.getMonth() == 11) {
                currentDate.setMonth(0);
                currentDate.setFullYear(currentDate.getFullYear() + 1);
            } else {
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            onDateChanged();
        });

        document.querySelectorAll('.day').forEach(dayCell => {
            dayCell.addEventListener('click', (event) => {
                const deleteCurrentMarkedDay = () => $('.marked')?.classList.remove('marked')

                let td = event.target;
                let dayOfWeek = td.cellIndex;
                let week = td.parentElement.sectionRowIndex;

                deleteCurrentMarkedDay();
                markedDate = dates[week][dayOfWeek];

                if (markedDate.getMonth() != currentDate.getMonth()) {
                    currentDate.setMonth(markedDate.getMonth());
                    currentDate.setFullYear(markedDate.getFullYear());
                    onDateChanged();
                } else {
                    td.classList.add("marked");
                }
            });
        })
        // ========================== LISTENERS ==========================================




        // ========================== UTILS ==============================================
        function placeDate(week, day, date) {
            let tbody = $('tbody');
            let tr = tbody.children[week];
            let td = tr.children[day];

            date.getTime() == markedDate.getTime()
                ? td.classList.add('marked')
                : td.classList.remove('marked');

            date.getMonth() != currentDate.getMonth()
                ? td.classList.add('disabled')
                : td.classList.remove('disabled');

            td.textContent = date.getDate();
        }

        function update_title() {
            $('#monthSelector').value = currentDate.getMonth();
            $('#yearSelector').value = currentDate.getFullYear();
        }


        function onDateChanged() {
            update_title();
            populateCalendar();
        }
        // ========================== UTILS ==============================================






        // ========================== POPULATES ==========================================
        function populateMonthSelector() {
            let monthSelector = $('#monthSelector');
            for (let month = 0; month < 12; month++) {
                let date = new Date(currentDate.getFullYear(), month);
                let monthName = DATETIME_FORMAT.formatToParts(date).filter((part) => part.type == "month").shift().value;

                let option = document.createElement('option');
                option.textContent = monthName;
                option.setAttribute('value', month);
                if (month == currentDate.getMonth()) {
                    monthSelector.value = currentDate.getMonth();
                }
                monthSelector.appendChild(option);
            }
        }

        function populateDayNames() {
            let dayNamesRow = $('.day-names');
            let date = new Date(2024, 3, 1); // random monday
            for (let day = 0; day < 7; day++) {
                let dayName = DATETIME_FORMAT.formatToParts(date).filter((part) => part.type == "weekday").shift().value;
                date.setDate(date.getDay() + 1);
                let th = dayNamesRow.cells[day];
                th.textContent = dayName;
            }
        }

        function populateCalendar() {
            let initialDate = new Date(currentDate.getFullYear(), currentDate.getMonth());

            let dayOfWeek = initialDate.getDay() == 0 ? 6 : initialDate.getDay() - 1;
            dates[0][dayOfWeek] = new Date(initialDate);
            placeDate(0, dayOfWeek, initialDate);

            let date = new Date(initialDate);
            for (let day = dayOfWeek - 1; day >= 0; day--) {
                date.setDate(date.getDate() - 1);
                dates[0][day] = new Date(date);
                placeDate(0, day, date);
            }

            for (let week = 0; week < dates.length; week++) {
                for (let day = week == 0 ? dayOfWeek + 1 : 0; day < dates[week].length; day++) {
                    initialDate.setDate(initialDate.getDate() + 1);
                    dates[week][day] = new Date(initialDate);
                    placeDate(week, day, initialDate);
                }
            }
        }
        // ========================== POPULATES ==========================================
    </script>
</body>

</html>